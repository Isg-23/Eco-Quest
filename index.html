<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Quest üå± - Save Our Planet!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #2d5016;
            overflow-x: hidden;
        }

        .floating-elements {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .leaf, .cloud, .star {
            position: absolute;
            animation: float 6s ease-in-out infinite;
        }

        .leaf {
            font-size: 24px;
            color: #4CAF50;
            animation-delay: 0s;
        }

        .cloud {
            font-size: 32px;
            color: rgba(255, 255, 255, 0.7);
            animation-delay: -2s;
        }

        .star {
            font-size: 16px;
            color: #FFD700;
            animation-delay: -4s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        header {
            background: linear-gradient(135deg, #2E8B57, #228B22);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo::before {
            content: "üåç";
            animation: spin 4s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        nav a:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        /* New Styles for logged-in state */
        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-stats {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            font-size: 1.5rem;
        }

        .hero {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="trees" patternUnits="userSpaceOnUse" width="20" height="20"><text x="2" y="15" font-size="12" fill="rgba(255,255,255,0.1)">üå≤</text></pattern></defs><rect width="100" height="100" fill="url(%23trees)"/></svg>');
            opacity: 0.3;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .hero p {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .cta-button {
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .cta-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .cta-button:active {
            transform: translateY(-1px) scale(1.02);
        }

        .section {
            padding: 4rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section h2 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 3rem;
            color: #2E7D32;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .quest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .quest-card {
            background: linear-gradient(145deg, #ffffff, #f0f8f0);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 3px solid #E8F5E8;
        }

        .quest-card::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(76, 175, 80, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .quest-card:hover::before {
            opacity: 1;
        }

        .quest-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border-color: #4CAF50;
        }

        .quest-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
            display: block;
        }

        .quest-card h3 {
            color: #2E7D32;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .quest-card p {
            color: #555;
            margin-bottom: 1.5rem;
            text-align: center;
            line-height: 1.6;
        }

        .quest-button {
            background: linear-gradient(45deg, #4CAF50, #81C784);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .quest-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .quest-button:hover::before {
            left: 100%;
        }

        .quest-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .difficulty {
            display: inline-block;
            background: #FFE082;
            color: #F57F17;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .profile-container {
            background: linear-gradient(145deg, #ffffff, #f0f8f0);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(45deg, #4CAF50, #81C784);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .badges-container {
            margin-top: 2rem;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }

        .badge {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .badge:hover {
            transform: scale(1.05);
        }

        .badge-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .badge-name {
            font-size: 0.8rem;
            color: #555;
            font-weight: bold;
        }

        .badge.locked {
            opacity: 0.5;
            background: #f5f5f5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(145deg, #ffffff, #f0f8f0);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #000;
        }

        .game-area {
            text-align: center;
            padding: 2rem 0;
        }

        .recycling-bins {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .bin {
            width: 100px;
            height: 120px;
            border: 3px dashed #ccc;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .bin.highlight {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .bin-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .bin-label {
            font-size: 0.8rem;
            font-weight: bold;
            color: #555;
        }

        .draggable-items {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .draggable-item {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            cursor: grab;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            min-width: 60px;
            text-align: center;
        }

        .draggable-item:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .draggable-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
            }

            nav ul {
                gap: 1rem;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .quest-grid {
                grid-template-columns: 1fr;
            }

            .recycling-bins {
                flex-direction: column;
                align-items: center;
            }
        }

        @keyframes success {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); background: #4CAF50; }
            100% { transform: scale(1); }
        }

        .success-animation {
            animation: success 0.5s ease-in-out;
        }

        .progress-container {
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(45deg, #4CAF50, #81C784);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .confetti {
            position: absolute;
            font-size: 20px;
            animation: confetti-fall 3s ease-in-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(-100vh) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #4CAF50, #81C784);
            color: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(300px);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: loading-spin 1s ease-in-out infinite;
        }

        @keyframes loading-spin {
            to { transform: rotate(360deg); }
        }

        /* NEW STYLES for Login/Signup and Leaderboard */
        .auth-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1rem;
            text-align: center;
        }

        .auth-container h3 {
            color: #2E7D32;
        }

        .auth-container input {
            padding: 0.8rem;
            border-radius: 10px;
            border: 2px solid #ddd;
            width: 100%;
            font-size: 1rem;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }

        .auth-container select {
            padding: 0.8rem;
            border-radius: 10px;
            border: 2px solid #ddd;
            width: 100%;
            font-size: 1rem;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: #fff;
        }

        .auth-container button {
            background: linear-gradient(45deg, #4CAF50, #81C784);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .auth-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .switch-auth {
            font-size: 0.9rem;
            cursor: pointer;
            color: #667eea;
            text-decoration: underline;
        }
        
        /* Leaderboard styles */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
        }

        .leaderboard-table th, .leaderboard-table td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .leaderboard-table th {
            background-color: #f2f2f2;
            color: #2E7D32;
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .leaderboard-table tr:hover {
            background-color: #e8f5e8;
        }
        
        .leaderboard-table tr.user-rank {
            background-color: #c8e6c9;
            font-weight: bold;
        }
        
        /* New styles for learning content */
        .learning-content {
            text-align: left;
        }
        .learning-content h3 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #2E7D32;
        }
        .learning-content p {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #555;
            margin-bottom: 1.5rem;
        }
        .learning-content ul {
            list-style: none;
            padding: 0;
            margin-bottom: 1.5rem;
        }
        .learning-content ul li {
            background: #E8F5E8;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 5px solid #4CAF50;
        }
        /* Responsive video container for Learn module */
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 */
            margin-top: 1rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            background: #000;
        }
        .video-container iframe,
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        
        /* Styles for profile icon selection */
        .icon-selection {
            text-align: center;
            margin-top: 1.5rem;
        }
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-top: 1rem;
        }
        .icon-option {
            font-size: 2rem;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background: #e0e0e0;
        }
        .icon-option:hover {
            transform: scale(1.1);
        }
        .icon-option.selected {
            border-color: #4CAF50;
            background: #c8e6c9;
        }
        
        /* New styles for profile avatar display */
        .profile-avatar-large {
            font-size: 5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .profile-username {
            font-size: 2rem;
            text-align: center;
            font-weight: bold;
            color: #2E7D32;
        }
    </style>
</head>
<body>
    <div class="floating-elements">
        <div class="leaf" style="left: 10%; top: 20%;">üçÉ</div>
        <div class="cloud" style="left: 80%; top: 15%;">‚òÅÔ∏è</div>
        <div class="leaf" style="left: 70%; top: 60%;">üåø</div>
        <div class="star" style="left: 20%; top: 70%;">‚≠ê</div>
        <div class="cloud" style="left: 40%; top: 80%;">‚òÅÔ∏è</div>
        <div class="leaf" style="left: 90%; top: 40%;">üçÉ</div>
    </div>

    <header>
        <div class="nav-container">
            <div class="logo">Eco-Quest</div>
            <nav>
                <ul>
                    <li><a href="#home" onclick="showSection('home')">üè† Home</a></li>
                    <li><a href="#quests" onclick="showSection('quests')">üéÆ Quests</a></li>
                    <li><a href="#learn" onclick="showSection('learn')">üìö Learn</a></li>
                    <li><a href="#levels" onclick="showSection('levels')">üéì Levels</a></li>
                    <li><a href="#profile" onclick="showSection('profile')">üë§ Profile</a></li>
                    <li><a href="#leaderboard" onclick="showSection('leaderboard')">üèÜ Leaderboard</a></li>
                </ul>
            </nav>
            <div id="user-display">
                <a href="#" class="user-stats" onclick="openAuthModal()">
                    <span>üë§ Login/Sign Up</span>
                </a>
            </div>
        </div>
    </header>

    <section id="home" class="hero">
        <div class="hero-content">
            <h1>üå± Welcome to Eco-Quest! üå±</h1>
            <p>Join the adventure to save our planet! Learn about nature, sustainability, and environmental protection through fun interactive quests and games.</p>
            <button class="cta-button" onclick="startAdventure()">
                üöÄ Start Your Green Adventure!
            </button>
        </div>
    </section>

    <section id="levels" class="section" style="display: none;">
        <h2>üéì Select Your Class Level</h2>
        <div class="quest-grid">
            <div class="quest-card">
                <div class="difficulty">1st ‚Äì 3rd Class</div>
                <div class="quest-icon">üå±</div>
                <h3>Beginner Explorers</h3>
                <p>Fun and simple activities to start your green journey.</p>
                <button class="quest-button" onclick="selectLevel('level_1_3')">Select Level</button>
            </div>
            <div class="quest-card">
                <div class="difficulty">4th ‚Äì 6th Class</div>
                <div class="quest-icon">üåø</div>
                <h3>Eco Learners</h3>
                <p>Explore recycling, trees, and nature with exciting missions.</p>
                <div style="text-align:center; color:#888; font-weight:bold; margin-top:1rem;">Games for this level are under progress.</div>
            </div>
            <div class="quest-card">
                <div class="difficulty">7th ‚Äì 9th Class</div>
                <div class="quest-icon">üå≥</div>
                <h3>Green Guardians</h3>
                <p>Dive deeper into conservation and renewable energy.</p>
                <div style="text-align:center; color:#888; font-weight:bold; margin-top:1rem;">Games for this level are under progress.</div>
            </div>
            <div class="quest-card">
                <div class="difficulty">10th ‚Äì 12th Class</div>
                <div class="quest-icon">‚òÄÔ∏è</div>
                <h3>Eco Champions</h3>
                <p>Advanced challenges focusing on sustainable cities and climate.</p>
                <div style="text-align:center; color:#888; font-weight:bold; margin-top:1rem;">Games for this level are under progress.</div>
            </div>
        </div>
        <p style="text-align:center; color:#555;">Your selection will personalize recommendations without removing any features.</p>
    </section>

    <section id="quests" class="section" style="display: none;">
        <h2>üéØ Your Eco-Missions</h2>
        <div class="quest-grid">
            <div class="quest-card">
                <div class="difficulty">‚≠ê Beginner</div>
                <div class="quest-icon">‚ôªÔ∏è</div>
                <h3>Recycling Hero</h3>
                <p>Learn to sort different types of waste into the correct recycling bins. Help reduce pollution and save our planet!</p>
                <div class="progress-container">
                    <div class="progress-bar" style="width: 0%">0%</div>
                </div>
                <button class="quest-button" onclick="if (checkLoginAndRedirect()) { startRecyclingGame(); }">Start Mission</button>
            </div>
            
            <div class="quest-card">
                <div class="difficulty">‚≠ê‚≠ê Intermediate</div>
                <div class="quest-icon">üå≥</div>
                <h3>Forest Guardian</h3>
                <p>Protect the rainforest by planting trees and learning about wildlife conservation. Every tree counts!</p>
                <div class="progress-container">
                    <div class="progress-bar" style="width: 0%">0%</div>
                </div>
                <button class="quest-button" onclick="if (checkLoginAndRedirect()) { startForestGame(); }">Start Mission</button>
            </div>
            
            <div class="quest-card">
                <div class="difficulty">‚≠ê‚≠ê‚≠ê Advanced</div>
                <div class="quest-icon">‚òÄÔ∏è</div>
                <h3>Solar City Builder</h3>
                <p>Design and build a sustainable city powered entirely by renewable energy sources!</p>
                <div class="progress-container">
                    <div class="progress-bar" style="width: 0%">0%</div>
                </div>
                <button class="quest-button" onclick="if (checkLoginAndRedirect()) { startSolarGame(); }">Start Mission</button>
            </div>
        </div>
    </section>

    <section id="learn" class="section" style="display: none;">
        <h2>üìñ Environmental Knowledge Hub</h2>
        <div class="quest-grid">
            <div class="quest-card">
                <div class="quest-icon">üåç</div>
                <h3>Climate Change Basics</h3>
                <p>Discover what climate change is and how it affects our planet.</p>
                <button class="quest-button" onclick="showClimateChangeInfo()">Learn More</button>
            </div>
            
            <div class="quest-card">
                <div class="quest-icon">üêº</div>
                <h3>Wildlife Conservation</h3>
                <p>Learn about endangered species and how we can protect them.</p>
                <button class="quest-button" onclick="showWildlifeInfo()">Learn More</button>
            </div>
            
            <div class="quest-card">
                <div class="quest-icon">üåä</div>
                <h3>Ocean Protection</h3>
                <p>Understand ocean pollution and marine ecosystem protection.</p>
                <button class="quest-button" onclick="showOceanInfo()">Learn More</button>
            </div>
        </div>
    </section>

    <section id="profile" class="section" style="display: none;">
        <h2>üèÜ Your Eco-Profile</h2>
        <div id="profile-content">
            <div class="profile-container">
                <div class="profile-avatar-large" id="profile-avatar">üë§</div>
                <div class="profile-username" id="profile-username">Guest</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="eco-points">0</div>
                        <div class="stat-label">üåü Eco-Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="quests-completed">0</div>
                        <div class="stat-label">‚úÖ Quests Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="badges-earned">0</div>
                        <div class="stat-label">üèÖ Badges Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="streak-days">0</div>
                        <div class="stat-label">üî• Day Streak</div>
                    </div>
                </div>
                
                <div class="badges-container">
                    <h3>üèÖ Your Eco-Badges</h3>
                    <div class="badges-grid">
                        <div class="badge locked" data-badge="recycling-novice">
                            <div class="badge-icon">‚ôªÔ∏è</div>
                            <div class="badge-name">Recycling Novice</div>
                        </div>
                        <div class="badge locked" data-badge="tree-planter">
                            <div class="badge-icon">üå≥</div>
                            <div class="badge-name">Tree Planter</div>
                        </div>
                        <div class="badge locked" data-badge="energy-saver">
                            <div class="badge-icon">‚ö°</div>
                            <div class="badge-name">Energy Saver</div>
                        </div>
                        <div class="badge locked" data-badge="ocean-protector">
                            <div class="badge-icon">üåä</div>
                            <div class="badge-name">Ocean Protector</div>
                        </div>
                        <div class="badge locked" data-badge="wildlife-friend">
                            <div class="badge-icon">üêº</div>
                            <div class="badge-name">Wildlife Friend</div>
                        </div>
                        <div class="badge locked" data-badge="eco-champion">
                            <div class="badge-icon">üèÜ</div>
                            <div class="badge-name">Eco Champion</div>
                        </div>
                    </div>
                </div>
                
                <div class="icon-selection">
                    <h3>üé® Choose Your Profile Icon</h3>
                    <div class="icon-grid" id="icon-grid"></div>
                </div>
            </div>
        </div>
        
        <div id="login-prompt" style="display: none; text-align: center; margin-top: 50px;">
            <p style="font-size: 1.5rem; color: #555;">Please log in or sign up to view your profile and track your progress!</p>
        </div>
    </section>
    
    <section id="leaderboard" class="section" style="display: none;">
        <h2>üèÜ Eco-Quest Leaderboard</h2>
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Username</th>
                    <th>Eco-Points</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
            </tbody>
        </table>
    </section>

    <div id="gameModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGame()">&times;</span>
            <div id="gameContent"></div>
        </div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAuthModal()">&times;</span>
            <div id="authContent" class="auth-container">
                
                <div id="login-form">
                    <h3>Log In</h3>
                    <input type="text" id="login-username" placeholder="Username" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    
                    <label for="login-class" style="margin-top: 0.5rem; color:#2E7D32; font-weight:bold;">Class Level (optional)</label>
                    <select id="login-class">
                        <option value="">Select class level (optional)</option>
                        <option value="level_1_3">üå± 1st‚Äì3rd Class</option>
                        <option value="level_4_6">üåø 4th‚Äì6th Class</option>
                        <option value="level_7_9">üå≥ 7th‚Äì9th Class</option>
                        <option value="level_10_12">‚òÄÔ∏è 10th‚Äì12th Class</option>
                    </select>

                    <button onclick="login()">Log In</button>
                    <p>Don't have an account? <span class="switch-auth" onclick="showSignup()">Sign Up</span></p>
                </div>

                <div id="signup-form" style="display: none;">
                    <h3>Sign Up</h3>
                    <input type="text" id="signup-username" placeholder="Username" required>
                    <input type="password" id="signup-password" placeholder="Password" required>
                    
                    <label for="signup-class" style="margin-top: 0.5rem; color:#2E7D32; font-weight:bold;">Select Your Class Level</label>
                    <select id="signup-class" required>
                        <option value="">Select your class level</option>
                        <option value="level_1_3">üå± 1st‚Äì3rd Class</option>
                        <option value="level_4_6">üåø 4th‚Äì6th Class</option>
                        <option value="level_7_9">üå≥ 7th‚Äì9th Class</option>
                        <option value="level_10_12">‚òÄÔ∏è 10th‚Äì12th Class</option>
                    </select>
                    
                    <div class="icon-selection">
                        <h4>Choose an Avatar</h4>
                        <div class="icon-grid" id="signup-icon-grid"></div>
                    </div>
                    
                    <button onclick="signup()">Sign Up</button>
                    <p>Already have an account? <span class="switch-auth" onclick="showLogin()">Log In</span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
    <div id="celebration" class="celebration"></div>

    <script>
        const profileIcons = ['üå≥', '‚ôªÔ∏è', '‚òÄÔ∏è', 'üêº', 'üåä', 'üå±', 'üåç', 'ü¶ã', 'üêù', 'ü¶ä', 'üêøÔ∏è', 'ü¶å', 'ü¶ú'];

        // --- State Management ---
        let gameState = {
            ecoPoints: 0,
            questsCompleted: 0,
            badgesEarned: 0,
            streakDays: 1,
            unlockedBadges: [],
            questProgress: {},
            username: null,
            avatar: 'üë§',
            selectedLevel: null
        };
        let users = JSON.parse(localStorage.getItem('ecoquest-users')) || {};
        let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser')) || null;

        function loadUsers() {
            users = JSON.parse(localStorage.getItem('ecoquest-users')) || {};
        }

        function saveUsers() {
            localStorage.setItem('ecoquest-users', JSON.stringify(users));
        }

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const loginSelectedLevel = document.getElementById('login-class').value;

            if (users[username] && users[username].password === password) {
                loggedInUser = username;
                localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                gameState = users[username].state;
                
                // If user picked a class level during login, update it
                if (loginSelectedLevel) {
                    gameState.selectedLevel = loginSelectedLevel;
                    saveProgress();
                }

                updateUI();
                closeAuthModal();
                showNotification(`Welcome back, ${username}!`, 3000);
            } else {
                showNotification('Invalid username or password.', 3000);
            }
        }

        function signup() {
            const username = document.getElementById('signup-username').value;
            const password = document.getElementById('signup-password').value;
            const selectedIcon = document.querySelector('#signup-icon-grid .icon-option.selected');
            const signupSelectedLevel = document.getElementById('signup-class').value;

            if (users[username]) {
                showNotification('Username already exists. Please choose another.', 3000);
                return;
            }
            if (username.length < 3 || password.length < 3) {
                showNotification('Username and password must be at least 3 characters.', 3000);
                return;
            }
            if (!selectedIcon) {
                showNotification('Please select a profile icon.', 3000);
                return;
            }
            if (!signupSelectedLevel) {
                showNotification('Please select your class level.', 3000);
                return;
            }

            users[username] = {
                password: password,
                state: {
                    ecoPoints: 0,
                    questsCompleted: 0,
                    badgesEarned: 0,
                    streakDays: 1,
                    unlockedBadges: [],
                    questProgress: {},
                    username: username,
                    avatar: selectedIcon.textContent,
                    selectedLevel: signupSelectedLevel
                }
            };
            saveUsers();
            showLogin();
            showNotification('Sign up successful! You can now log in.', 3000);
        }

        function logout() {
            loggedInUser = null;
            localStorage.removeItem('loggedInUser');
            gameState = {
                ecoPoints: 0,
                questsCompleted: 0,
                badgesEarned: 0,
                streakDays: 1,
                unlockedBadges: [],
                questProgress: {},
                username: null,
                avatar: 'üë§',
                selectedLevel: null
            };
            updateUI();
            showNotification('You have been logged out.', 3000);
            showSection('home');
        }

        function openAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
        }

        function showSignup() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
            renderIconSelection('#signup-icon-grid');
        }

        function renderIconSelection(containerId) {
            const container = document.querySelector(containerId);
            container.innerHTML = '';
            profileIcons.forEach(icon => {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'icon-option';
                iconDiv.textContent = icon;
                iconDiv.onclick = () => {
                    document.querySelectorAll(`${containerId} .icon-option`).forEach(el => el.classList.remove('selected'));
                    iconDiv.classList.add('selected');
                    if (loggedInUser && containerId === '#icon-grid') {
                        setProfileIcon(icon);
                    }
                };
                container.appendChild(iconDiv);
            });

            if (loggedInUser && containerId === '#icon-grid') {
                const currentIconElement = Array.from(document.querySelectorAll(`${containerId} .icon-option`)).find(el => el.textContent === gameState.avatar);
                if (currentIconElement) {
                    currentIconElement.classList.add('selected');
                }
            } else if (containerId === '#signup-icon-grid' && !document.querySelector(`${containerId} .icon-option.selected`)) {
                // Pre-select the first one for new signups if none is selected
                document.querySelector(`${containerId} .icon-option`).classList.add('selected');
            }
        }

        function setProfileIcon(icon) {
            if (loggedInUser) {
                gameState.avatar = icon;
                saveProgress();
                updateUI();
                showNotification('Profile icon updated!', 2000);
            }
        }

        function loadProgress() {
            loadUsers();
            loggedInUser = JSON.parse(localStorage.getItem('loggedInUser')) || null;
            if (loggedInUser && users[loggedInUser]) {
                gameState = users[loggedInUser].state;
            } else {
                // This block is left in for backward compatibility, though all progress is now tied to loggedInUser
                const saved = localStorage.getItem('ecoquest-progress');
                if (saved) { 
                    gameState = { ...gameState, ...JSON.parse(saved) };
                }
            }
            updateUI();
        }

        function saveProgress() {
            if (loggedInUser) {
                users[loggedInUser].state = gameState;
                saveUsers();
            } else {
                 // Save the guest state (less important but good practice)
                 localStorage.setItem('ecoquest-progress', JSON.stringify(gameState));
            }
        }

        const levelGroups = {
            'level_1_3': { name: '1st‚Äì3rd', icon: 'üå±' },
            'level_4_6': { name: '4th‚Äì6th', icon: 'üåø' },
            'level_7_9': { name: '7th‚Äì9th', icon: 'üå≥' },
            'level_10_12': { name: '10th‚Äì12th', icon: '‚òÄÔ∏è' }
        };

        function getSelectedLevelLabel() {
            if (!gameState.selectedLevel) return '';
            const lv = levelGroups[gameState.selectedLevel];
            return lv ? `${lv.icon} ${lv.name}` : '';
        }

        function selectLevel(levelKey) {
            if (!levelGroups[levelKey]) {
                showNotification('Invalid level selection.', 3000);
                return;
            }
            gameState.selectedLevel = levelKey;
            saveProgress();
            updateUI();
            const label = getSelectedLevelLabel();
            showNotification(`üéì Level selected: ${label}`, 3000);
            // After selecting, guide user to quests
            showSection('quests');
        }

        function updateUI() {
            const userDisplay = document.getElementById('user-display');
            if (loggedInUser) {
                userDisplay.innerHTML = `
                    <div class="user-info">
                        <span class="user-avatar">${gameState.avatar}</span>
                        <span>üëã Hi, ${loggedInUser}</span>
                        <span>üåü ${gameState.ecoPoints}</span>
                        ${gameState.selectedLevel ? `<span class="difficulty" style="background:#E3F2FD;color:#1565C0;">${getSelectedLevelLabel()}</span>` : ''}
                        <a href="#" style="text-decoration: none; color: white;" onclick="logout()">üö™ Logout</a>
                    </div>
                `;
            } else {
                userDisplay.innerHTML = `
                    <a href="#" class="user-stats" onclick="openAuthModal()">
                        <span>üë§ Login/Sign Up</span>
                    </a>
                `;
            }

            // Update the profile section visibility
            const profileContent = document.getElementById('profile-content');
            const loginPrompt = document.getElementById('login-prompt');
            if (loggedInUser) {
                profileContent.style.display = 'block';
                loginPrompt.style.display = 'none';
                
                document.getElementById('profile-avatar').textContent = gameState.avatar;
                document.getElementById('profile-username').textContent = gameState.username;
                document.getElementById('eco-points').textContent = gameState.ecoPoints;
                document.getElementById('quests-completed').textContent = gameState.questsCompleted;
                document.getElementById('badges-earned').textContent = gameState.badgesEarned;
                document.getElementById('streak-days').textContent = gameState.streakDays;

                // Update badges
                document.querySelectorAll('.badge').forEach(badgeEl => {
                    badgeEl.classList.add('locked'); // Lock all first
                });
                gameState.unlockedBadges.forEach(badgeId => {
                    const badgeElement = document.querySelector(`[data-badge="${badgeId}"]`);
                    if (badgeElement) {
                        badgeElement.classList.remove('locked');
                    }
                });
                
                renderIconSelection('#icon-grid');
            } else {
                profileContent.style.display = 'none';
                loginPrompt.style.display = 'block';
            }

            updateLeaderboard();
        }

        function updateLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboard-body');
            leaderboardBody.innerHTML = '';

            const allPlayers = Object.keys(users).map(username => ({
                username: username,
                points: users[username].state.ecoPoints,
                avatar: users[username].state.avatar || 'üë§'
            }));

            allPlayers.sort((a, b) => b.points - a.points);

            allPlayers.slice(0, 10).forEach((player, index) => {
                const row = document.createElement('tr');
                if (loggedInUser && player.username === loggedInUser) {
                    row.classList.add('user-rank');
                }
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><span class="user-avatar">${player.avatar}</span> ${player.username}</td>
                    <td>${player.points}</td>
                `;
                leaderboardBody.appendChild(row);
            });

            // Show current user's rank if not in top 10
            if (loggedInUser) {
                const userRank = allPlayers.findIndex(p => p.username === loggedInUser);
                if (userRank >= 10) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `<td colspan="3" style="text-align: center;">...</td>`;
                    leaderboardBody.appendChild(separatorRow);

                    const userRow = document.createElement('tr');
                    userRow.classList.add('user-rank');
                    userRow.innerHTML = `
                        <td>${userRank + 1}</td>
                        <td><span class="user-avatar">${allPlayers[userRank].avatar}</span> ${allPlayers[userRank].username}</td>
                        <td>${allPlayers[userRank].points}</td>
                    `;
                    leaderboardBody.appendChild(userRow);
                }
            }
        }

        // --- Core Utility Functions ---
        function checkLoginAndRedirect() {
            if (!loggedInUser) {
                openAuthModal();
                showNotification('Please log in or sign up to start a mission.', 3000);
                return false;
            }
            return true;
        }

        function openGameModal(title, content) {
            document.getElementById('gameContent').innerHTML = `<h3>${title}</h3>${content}`;
            document.getElementById('gameModal').style.display = 'block';
        }

        function closeGame() {
            document.getElementById('gameModal').style.display = 'none';
            // Reset Recycling Game state
            currentItemIndex = 0;
            correctDrops = 0;
            // Reset Forest Game state (not strictly needed but good practice)
            treesPlanted = 0;
            // Reset Solar Game state
            housesPowered = 0;
        }

        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function startAdventure() {
            showSection('quests');
        }

        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function addEcoPoints(points) {
            gameState.ecoPoints += points;
            saveProgress();
            updateUI();
        }

        function addQuestCompleted() {
            gameState.questsCompleted += 1;
            saveProgress();
            updateUI();
        }
        
        function unlockBadge(badgeId) {
            if (!gameState.unlockedBadges.includes(badgeId)) {
                gameState.unlockedBadges.push(badgeId);
                gameState.badgesEarned = gameState.unlockedBadges.length;
                saveProgress();
                updateUI();
                const badgeElement = document.querySelector(`[data-badge="${badgeId}"]`);
                if (badgeElement) {
                    showNotification(`üèÖ Badge Unlocked: ${badgeElement.querySelector('.badge-name').textContent}!`, 3000);
                }
            }
        }

        function celebrate() {
            const celebration = document.getElementById('celebration');
            const confettiEmojis = ['‚ú®', 'üåü', 'üéâ', 'üéä', 'ü•≥', 'üéà'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = confettiEmojis[Math.floor(Math.random() * confettiEmojis.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDuration = Math.random() * 2 + 3 + 's';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                celebration.appendChild(confetti);
            }
            
            setTimeout(() => {
                celebration.innerHTML = '';
            }, 5000);
        }
        
        // --- Learn Section Modals (Stubbed with content) ---
        function showClimateChangeInfo() {
            const content = `
                <div class="learning-content">
                    <h3>What is Climate Change? üåç</h3>
                    <p>Climate change is the long-term shift in temperatures and weather patterns. While some changes are natural, the current rapid warming is largely caused by human activities, primarily from burning fossil fuels like coal, oil, and gas, which release **greenhouse gases** (like Carbon Dioxide) into the atmosphere.</p>
                    
                    <h4>How We Can Help:</h4>
                    <ul>
                        <li>**Reduce Energy Use:** Turn off lights and unplug electronics.</li>
                        <li>**Use Public Transport:** Walk, bike, or take the bus instead of driving.</li>
                        <li>**Support Renewable Energy:** Advocate for solar and wind power.</li>
                    </ul>
                    
                    <div class="video-container">
                        <iframe src="https://www.youtube.com/embed/gqR1R67kH9o" allowfullscreen></iframe>
                    </div>
                </div>
            `;
            openGameModal('üìö Climate Change Basics', content);
        }
        
        function showWildlifeInfo() {
             const content = `
                <div class="learning-content">
                    <h3>Protecting Our Wild Friends üêº</h3>
                    <p>Wildlife conservation is the practice of protecting animal species and their habitats. Many species are becoming endangered due to habitat loss (deforestation), pollution, and climate change.</p>
                    
                    <h4>Simple Actions You Can Take:</h4>
                    <ul>
                        <li>**Reduce Plastic:** Keep plastics out of oceans and forests.</li>
                        <li>**Plant Native Species:** Grow plants that local insects and animals rely on.</li>
                        <li>**Support Sanctuaries:** Support organizations that protect wildlife habitats.</li>
                    </ul>
                    <div class="video-container">
                        <iframe src="https://www.youtube.com/embed/N0y7eXvjYkQ" allowfullscreen></iframe>
                    </div>
                </div>
            `;
            openGameModal('üìö Wildlife Conservation', content);
        }
        
        function showOceanInfo() {
             const content = `
                <div class="learning-content">
                    <h3>Deep Dive: Ocean Protection üåä</h3>
                    <p>Our oceans cover over 70% of the Earth and are vital for life. They absorb massive amounts of CO2, but face severe threats from plastic pollution, oil spills, and overfishing, which disrupt fragile marine ecosystems like coral reefs.</p>
                    
                    <h4>Be an Ocean Hero:</h4>
                    <ul>
                        <li>**Choose Sustainable Seafood:** Look for products from sustainable fisheries.</li>
                        <li>**Organize Beach Cleanups:** Participate in local cleanups.</li>
                        <li>**Avoid Single-Use Plastics:** Every plastic bag you skip helps the sea!</li>
                    </ul>
                    <div class="video-container">
                        <iframe src="https://www.youtube.com/embed/B8Xb1_5D42g" allowfullscreen></iframe>
                    </div>
                </div>
            `;
            openGameModal('üìö Ocean Protection', content);
        }
        
        // --- GAME LOGIC START ---

        // ** RECYCLING HERO QUEST (Drag and Drop) **
        const recyclingItems = [
            { item: 'Plastic Bottle', type: 'Plastic' },
            { item: 'Newspaper', type: 'Paper' },
            { item: 'Glass Jar', type: 'Glass' },
            { item: 'Banana Peel', type: 'Organic' },
            { item: 'Aluminium Can', type: 'Metal' },
            { item: 'Cardboard Box', type: 'Paper' },
            { item: 'Yogurt Cup', type: 'Plastic' }
        ];
        const recyclingBins = {
            'Plastic': { label: 'Plastic', icon: '‚ô≥', color: '#FFEB3B' },
            'Paper': { label: 'Paper', icon: 'üì∞', color: '#2196F3' },
            'Glass': { label: 'Glass', icon: 'üçæ', color: '#4CAF50' },
            'Organic': { label: 'Organic', icon: 'üçé', color: '#795548' },
            'Metal': { label: 'Metal', icon: 'üî©', color: '#9E9E9E' }
        };
        let currentItemIndex = 0;
        let correctDrops = 0;
        let totalItems = 5; // The number of items the user needs to sort to pass
        let dragItem = null;

        function startRecyclingGame() {
            currentItemIndex = 0;
            correctDrops = 0;
            initializeRecyclingGame();
        }

        function initializeRecyclingGame() {
            const gameContent = `
                <p>Drag the item to the correct bin! Correctly sort ${totalItems} items to complete the quest.</p>
                <div class="progress-container" style="width: 80%; margin: 1rem auto;">
                    <div id="recycling-progress-bar" class="progress-bar" style="width: 0%">0/${totalItems}</div>
                </div>
                <div id="item-to-sort" style="font-size: 2.5rem; font-weight: bold; margin: 2rem 0;"></div>
                <div id="recycling-bins" class="recycling-bins">
                    ${Object.keys(recyclingBins).map(type => `
                        <div class="bin" data-type="${type}" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
                            <span class="bin-icon" style="color: ${recyclingBins[type].color};">${recyclingBins[type].icon}</span>
                            <span class="bin-label">${recyclingBins[type].label}</span>
                        </div>
                    `).join('')}
                </div>
                <div id="draggable-item-container" class="draggable-items"></div>
            `;
            openGameModal('‚ôªÔ∏è Recycling Hero Quest', gameContent);
            loadNextRecyclingItem();

            // Re-attach drop listeners (important for dynamic content)
            document.querySelectorAll('.bin').forEach(bin => {
                bin.addEventListener('dragover', (e) => e.preventDefault());
                bin.addEventListener('drop', handleDrop);
                bin.addEventListener('dragenter', (e) => bin.classList.add('highlight'));
                bin.addEventListener('dragleave', (e) => bin.classList.remove('highlight'));
            });
        }

        function loadNextRecyclingItem() {
            if (correctDrops >= totalItems) {
                completeRecyclingQuest();
                return;
            }

            // Cycle through items, but limit to totalItems completions
            const item = recyclingItems[currentItemIndex % recyclingItems.length];
            document.getElementById('item-to-sort').textContent = item.item;

            const container = document.getElementById('draggable-item-container');
            container.innerHTML = `
                <div class="draggable-item" draggable="true" data-type="${item.type}">
                    ${item.item}
                </div>
            `;
            dragItem = container.querySelector('.draggable-item');
            dragItem.addEventListener('dragstart', handleDragStart);

            // Increment index for the next item
            currentItemIndex++;
        }

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.type);
            e.target.classList.add('dragging');
        }

        function handleDrop(e) {
            e.preventDefault();
            const itemType = e.dataTransfer.getData('text/plain');
            const binType = e.currentTarget.dataset.type;
            const binElement = e.currentTarget;

            // Remove dragging class from the item and highlight from the bin
            const itemElement = document.getElementById('draggable-item-container').querySelector('.draggable-item');
            if(itemElement) itemElement.classList.remove('dragging');
            binElement.classList.remove('highlight');

            if (itemType === binType) {
                correctDrops++;
                showNotification(`‚úÖ Correct! You recycled the ${itemType} item.`, 1500);
                binElement.classList.add('success-animation');
                setTimeout(() => binElement.classList.remove('success-animation'), 500);

                // Update progress bar
                const progressBar = document.getElementById('recycling-progress-bar');
                const percentage = (correctDrops / totalItems) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${correctDrops}/${totalItems}`;

                // Remove the dragged item
                document.getElementById('draggable-item-container').innerHTML = '';

                loadNextRecyclingItem();
            } else {
                showNotification(`‚ùå Incorrect! A ${itemType} item does not go into the ${binType} bin. Try again.`, 2000);
                // The draggable item is still there, user can try again
            }
        }

        function completeRecyclingQuest() {
            addEcoPoints(50);
            showNotification('ü•≥ Quest Completed! You earned the Recycling Novice badge!', 4000);
            unlockBadge('recycling-novice');
            addQuestCompleted();
            celebrate();
            // Clear all event listeners on bins to prevent multiple triggers after game over
            document.querySelectorAll('.bin').forEach(bin => {
                bin.removeEventListener('drop', handleDrop);
                bin.removeEventListener('dragover', (e) => e.preventDefault());
                bin.removeEventListener('dragenter', (e) => bin.classList.add('highlight'));
                bin.removeEventListener('dragleave', (e) => bin.classList.remove('highlight'));
            });
            setTimeout(closeGame, 2000);
        }
        
        // ** FOREST GUARDIAN QUEST (Click to Plant) **
        let treesPlanted = 0;
        const totalTrees = 10;
        const forestGridSize = 25; // 5x5 grid

        function startForestGame() {
            treesPlanted = 0;
            openGameModal('üå≥ Forest Guardian Quest', '<h3>Plant the Trees!</h3><p>Click on the empty spots (x) to plant new trees (üå≥) and save the forest! Plant 10 trees to complete the quest.</p><div id="forest-game-area" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 300px; margin: 20px auto;"></div><p id="trees-planted-count">Trees Planted: 0/10</p>');
            initializeForestGame();
        }

        function initializeForestGame() {
            const forestArea = document.getElementById('forest-game-area');
            forestArea.innerHTML = '';
            
            for (let i = 0; i < forestGridSize; i++) {
                const spot = document.createElement('div');
                spot.style.width = '50px';
                spot.style.height = '50px';
                spot.style.border = '2px dashed #8BC34A';
                spot.style.borderRadius = '5px';
                spot.style.cursor = 'pointer';
                spot.style.display = 'flex';
                spot.style.alignItems = 'center';
                spot.style.justifyContent = 'center';
                spot.style.fontSize = '2rem';
                spot.textContent = 'x'; // Placeholder for an empty spot
                spot.onclick = plantTree;
                forestArea.appendChild(spot);
            }
            updateForestStatus();
        }

        function plantTree(event) {
            if (treesPlanted < totalTrees && event.target.textContent === 'x') {
                event.target.textContent = 'üå≥';
                event.target.style.border = 'none';
                event.target.style.background = 'none';
                event.target.onclick = null; // Prevent planting another tree on the same spot
                treesPlanted++;
                updateForestStatus();
                showNotification('üíö Tree planted!', 1000);
                
                if (treesPlanted === totalTrees) {
                    completeForestQuest();
                }
            }
        }

        function updateForestStatus() {
            document.getElementById('trees-planted-count').textContent = `Trees Planted: ${treesPlanted}/${totalTrees}`;
        }

        function completeForestQuest() {
            addEcoPoints(75);
            showNotification('üéâ Quest Completed! You earned the Tree Planter badge!', 4000);
            unlockBadge('tree-planter');
            addQuestCompleted();
            celebrate();
            setTimeout(closeGame, 2000);
        }

        // ** SOLAR CITY BUILDER QUEST (Drag and Drop) **
        let housesPowered = 0;
        const totalHouses = 3;

        function startSolarGame() {
            housesPowered = 0;
            openGameModal('‚òÄÔ∏è Solar City Builder', '<h3>Power Up the City!</h3><p>Drag solar panels onto the rooftops of the three houses to power the city. (Drag & Drop)</p><div id="solar-game-area" style="padding: 2rem; text-align: center;"><div id="houses-container" style="display: flex; justify-content: space-around; margin-bottom: 2rem;"></div><div id="panels-container" style="display: flex; justify-content: center; gap: 1rem;"></div><p id="solar-status">Houses Powered: 0/3</p></div>');
            initializeSolarGame();
        }

        function initializeSolarGame() {
            const housesContainer = document.getElementById('houses-container');
            const panelsContainer = document.getElementById('panels-container');
            housesContainer.innerHTML = '';
            panelsContainer.innerHTML = '';

            // Create houses (drop zones)
            for (let i = 1; i <= totalHouses; i++) {
                const house = document.createElement('div');
                house.className = 'bin'; // Reusing bin style for drop zone
                house.style.width = '120px';
                house.style.height = '120px';
                house.style.border = '3px dashed #FF9800';
                house.style.borderRadius = '10px';
                house.style.margin = '0 10px';
                house.dataset.houseId = i;
                house.dataset.powered = 'false';
                house.innerHTML = '<span class="bin-icon">üè†</span><span class="bin-label">House ' + i + '</span>';
                
                // Add drag/drop listeners
                house.addEventListener('dragover', (e) => e.preventDefault());
                house.addEventListener('drop', handleSolarDrop);
                house.addEventListener('dragenter', (e) => house.classList.add('highlight'));
                house.addEventListener('dragleave', (e) => house.classList.remove('highlight'));
                
                housesContainer.appendChild(house);
            }

            // Create solar panels (draggable items)
            for (let i = 0; i < totalHouses; i++) {
                const panel = document.createElement('div');
                panel.className = 'draggable-item';
                panel.textContent = '‚òÄÔ∏è Solar Panel';
                panel.dataset.panelId = i;
                panel.draggable = true;
                
                panel.addEventListener('dragstart', handleSolarDragStart);
                panelsContainer.appendChild(panel);
            }
            updateSolarStatus();
        }

        function handleSolarDragStart(e) {
            e.dataTransfer.setData('text/plain', 'solar-panel');
            e.target.dataset.draggedId = e.target.dataset.panelId; // Store unique ID
            e.target.classList.add('dragging');
        }

        function handleSolarDrop(e) {
            e.preventDefault();
            const data = e.dataTransfer.getData('text/plain');
            const houseElement = e.currentTarget;
            
            // Remove dragging class from all panels and highlight from the bin
            document.querySelectorAll('#panels-container .draggable-item').forEach(panel => panel.classList.remove('dragging'));
            houseElement.classList.remove('highlight');

            if (data === 'solar-panel' && houseElement.dataset.powered === 'false') {
                houseElement.dataset.powered = 'true';
                houseElement.style.border = '3px solid #4CAF50';
                houseElement.innerHTML = '<span class="bin-icon">üè†‚ö°Ô∏è</span><span class="bin-label">Powered!</span>';
                houseElement.classList.add('success-animation');
                setTimeout(() => houseElement.classList.remove('success-animation'), 500);

                housesPowered++;
                showNotification(`‚úÖ House ${houseElement.dataset.houseId} powered!`, 1500);
                
                // Find and remove the draggable panel that was used
                const panelsContainer = document.getElementById('panels-container');
                const panelToRemove = document.querySelector(`[data-panel-id="${e.dataTransfer.getData('draggedId')}"]`);
                
                // This is a simplified removal, based on which one the browser "thinks" was dragged
                const allPanels = panelsContainer.querySelectorAll('.draggable-item');
                if (allPanels.length > 0) {
                    allPanels[0].remove();
                }

                updateSolarStatus();
                
                if (housesPowered === totalHouses) {
                    completeSolarQuest();
                }
            } else if (houseElement.dataset.powered === 'true') {
                showNotification('This house is already powered!', 1500);
            } else {
                showNotification('‚ùå Wrong item. Only solar panels will work!', 1500);
            }
        }

        function updateSolarStatus() {
            document.getElementById('solar-status').textContent = `Houses Powered: ${housesPowered}/${totalHouses}`;
        }

        function completeSolarQuest() {
            addEcoPoints(100);
            showNotification('üåü Quest Completed! You earned the Energy Saver badge!', 4000);
            unlockBadge('energy-saver');
            addQuestCompleted();
            celebrate();
            setTimeout(closeGame, 2000);
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', (event) => {
            loadProgress();

            // Add extra floating elements for visual effect
            setTimeout(() => {
                const floatingContainer = document.querySelector('.floating-elements');
                const newElements = ['ü¶ã', 'üêù', 'üå∫', 'üå∏'];
                newElements.forEach((emoji, index) => {
                    const element = document.createElement('div');
                    element.className = 'leaf';
                    element.textContent = emoji;
                    element.style.left = Math.random() * 80 + '%';
                    element.style.top = Math.random() * 80 + '%';
                    element.style.animationDelay = index * 1.5 + 's';
                    floatingContainer.appendChild(element);
                });
            }, 2000);
            
            if (loggedInUser) {
                showNotification(`Welcome back, ${loggedInUser}!`, 4000);
            } else if (localStorage.getItem('ecoquest-progress') === null) {
                setTimeout(() => {
                    showNotification('üå± Welcome to Eco-Quest! Start your green adventure today!', 4000);
                }, 1000);
            }
        });

        document.addEventListener('dragend', function() {
            document.querySelectorAll('.bin').forEach(bin => {
                bin.classList.remove('highlight');
            });
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.classList.remove('dragging');
            });
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeGame();
                closeAuthModal();
            }
        });
    </script>
</body>
</html>
